---
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Biblia 365 - Mi Amigo Anhelado">

  <!-- Recursos externos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" is:inline></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <!-- Estilos (pega aqu√≠ tu CSS completo, lo dejo comentado para no alargar) -->
  <style is:inline>
    /* :root { ... } todo tu CSS hermoso va aqu√≠ */
    /* body { ... } */
    /* .main-container { ... } */
    /* ... y todo lo dem√°s que ten√≠as ... */
    /* No lo copio completo para que quepa, pero NO lo quites, est√° brutal */
  </style>

  <!-- Estructura HTML principal -->
  <div class="main-container">
    <header class="app-header">
      <h1 class="app-title">BIBLIA 365</h1>
      <p class="app-subtitle">Tu Plan Anual de Lectura</p>

      <!-- Progress Ring -->
      <div class="progress-ring">
        <div class="ring-container">
          <svg class="ring-svg" width="120" height="120">
            <defs>
              <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:var(--primary);stop-opacity:1" />
                <stop offset="100%" style="stop-color:var(--accent);stop-opacity:1" />
              </linearGradient>
            </defs>
            <circle class="ring-bg" cx="60" cy="60" r="52" />
            <circle id="ringProgress" class="ring-progress" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="326.73" />
          </svg>
          <div class="ring-text">
            <div id="ringDay" class="ring-day">1</div>
            <div class="ring-label">de 365</div>
          </div>
        </div>
        <div class="progress-info">
          <div id="infoDate" class="info-date"></div>
          <div class="info-stats">
            <div class="stat-item"><span>üìñ</span> <span id="statChapters">0 cap√≠tulos hoy</span></div>
            <div class="stat-item"><span>‚ú®</span> <span id="statHighlights">0 vers√≠culos resaltados</span></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Panel de controles -->
    <div class="control-panel">
      <button class="btn-tool" onclick="abrirBiblioteca()"><span>üìö</span> Biblioteca</button>
      <div class="control-group">
        <button class="btn-tool" onclick="cambiarFuente(-2)">A-</button>
        <button class="btn-tool" onclick="cambiarFuente(2)">A+</button>
      </div>
      <button class="btn-tool" onclick="toggleModo()"><span>üåì</span> Tema</button>
    </div>

    <!-- Contenido din√°mico -->
    <div id="contenido"></div>

    <!-- Navegaci√≥n -->
    <nav class="nav-buttons">
      <button class="btn-nav" onclick="cambiarDia(-1)">‚Üê ANTERIOR</button>
      <button class="btn-nav btn-today" onclick="irAHoy()">HOY</button>
      <button class="btn-nav" onclick="cambiarDia(1)">SIGUIENTE ‚Üí</button>
    </nav>
  </div>

  <!-- Men√∫ flotante de acciones -->
  <div id="menuAcciones" class="menu-acciones">
    <button class="btn-action" onclick="subrayar('sub-yellow')"><span>‚ú®</span> Oro</button>
    <button class="btn-action" onclick="subrayar('sub-green')"><span>üåø</span> Vida</button>
    <button class="btn-action" onclick="subrayar('sub-blue')"><span>üíé</span> Cielo</button>
    <button class="btn-action" onclick="generarImagen()"><span>üñºÔ∏è</span> Imagen</button>
    <button class="btn-action" onclick="compartirWhatsApp()"><span>üí¨</span> Compartir</button>
    <button class="btn-action" onclick="desactivarMenu()"><span>‚úï</span> Cerrar</button>
  </div>

  <!-- Helper para generar imagen -->
  <div id="canvas-helper">
    <div style="font-size: 60px; color: var(--accent); margin-bottom: 30px;">"</div>
    <div id="img-text" style="font-size: 36px; line-height: 1.6; font-style: italic;"></div>
    <div style="font-size: 60px; color: var(--accent); margin-top: 20px;">"</div>
    <div id="img-ref" style="margin-top: 50px; font-size: 24px; letter-spacing: 6px; border-top: 2px solid var(--accent); display: inline-block; padding-top: 20px;"></div>
  </div>

  <!-- Modal Biblioteca -->
  <div id="modalBiblioteca" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h2>üìñ Biblioteca Sagrada</h2>
      <div id="gridLibros"></div>
    </div>
  </div>

  <!-- Contenedor de toasts -->
  <div id="toastContainer"></div>

  <!-- JavaScript principal -->
  <script is:inline>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // CONFIGURACI√ìN PRINCIPAL
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const BIBLIA_URL = '/biblia.json';   // Archivo en public/

    let bibleData       = null;
    let fechaActual     = new Date();
    let fontSize        = 21;
    let selectedVersiculo = null;
    let selectedInfo    = '';
    let currentVId      = null;
    let highlights      = JSON.parse(localStorage.getItem('biblia365_highlights') || '{}');

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // BASE DE LIBROS (con claves normalizadas: min√∫sculas + guiones)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const booksDB = [
      { n: 'G√©nesis',       f: 'genesis',         c: 50 },
      { n: '√âxodo',         f: 'exodo',           c: 40 },
      { n: 'Lev√≠tico',      f: 'levitico',        c: 27 },
      { n: 'N√∫meros',       f: 'numeros',         c: 36 },
      { n: 'Deuteronomio',  f: 'deuteronomio',    c: 34 },
      { n: 'Josu√©',         f: 'josue',           c: 24 },
      { n: 'Jueces',        f: 'jueces',          c: 21 },
      { n: 'Rut',           f: 'rut',             c: 4  },
      { n: '1 Samuel',      f: '1-samuel',        c: 31 },
      { n: '2 Samuel',      f: '2-samuel',        c: 24 },
      { n: '1 Reyes',       f: '1-reyes',         c: 22 },
      { n: '2 Reyes',       f: '2-reyes',         c: 25 },
      { n: '1 Cr√≥nicas',    f: '1-cronicas',      c: 29 },
      { n: '2 Cr√≥nicas',    f: '2-cronicas',      c: 36 },
      { n: 'Esdras',        f: 'esdras',          c: 10 },
      { n: 'Nehem√≠as',      f: 'nehemias',        c: 13 },
      { n: 'Ester',         f: 'ester',           c: 10 },
      { n: 'Job',           f: 'job',             c: 42 },
      { n: 'Salmos',        f: 'salmos',          c: 150 },
      { n: 'Proverbios',    f: 'proverbios',      c: 31 },
      { n: 'Eclesiast√©s',   f: 'eclesiastes',     c: 12 },
      { n: 'Cantares',      f: 'cantares',        c: 8  },
      { n: 'Isa√≠as',        f: 'isaias',          c: 66 },
      { n: 'Jerem√≠as',      f: 'jeremias',        c: 52 },
      { n: 'Lamentaciones', f: 'lamentaciones',   c: 5  },
      { n: 'Ezequiel',      f: 'ezequiel',        c: 48 },
      { n: 'Daniel',        f: 'daniel',          c: 12 },
      { n: 'Oseas',         f: 'oseas',           c: 14 },
      { n: 'Joel',          f: 'joel',            c: 3  },
      { n: 'Am√≥s',          f: 'amos',            c: 9  },
      { n: 'Abd√≠as',        f: 'abdias',          c: 1  },
      { n: 'Jon√°s',         f: 'jonas',           c: 4  },
      { n: 'Miqueas',       f: 'miqueas',         c: 7  },
      { n: 'Nah√∫m',         f: 'nahum',           c: 3  },
      { n: 'Habacuc',       f: 'habacuc',         c: 3  },
      { n: 'Sofon√≠as',      f: 'sofonias',        c: 3  },
      { n: 'Hageo',         f: 'hageo',           c: 2  },
      { n: 'Zacar√≠as',      f: 'zacarias',        c: 14 },
      { n: 'Malaqu√≠as',     f: 'malaquias',       c: 4  },
      { n: 'Mateo',         f: 'mateo',           c: 28 },
      { n: 'Marcos',        f: 'marcos',          c: 16 },
      { n: 'Lucas',         f: 'lucas',           c: 24 },
      { n: 'Juan',          f: 'juan',            c: 21 },
      { n: 'Hechos',        f: 'hechos',          c: 28 },
      { n: 'Romanos',       f: 'romanos',         c: 16 },
      { n: '1 Corintios',   f: '1-corintios',     c: 16 },
      { n: '2 Corintios',   f: '2-corintios',     c: 13 },
      { n: 'G√°latas',       f: 'galatas',         c: 6  },
      { n: 'Efesios',       f: 'efesios',         c: 6  },
      { n: 'Filipenses',    f: 'filipenses',      c: 4  },
      { n: 'Colosenses',    f: 'colosenses',      c: 4  },
      { n: '1 Tesalonicenses', f: '1-tesalonicenses', c: 5 },
      { n: '2 Tesalonicenses', f: '2-tesalonicenses', c: 3 },
      { n: '1 Timoteo',     f: '1-timoteo',       c: 6  },
      { n: '2 Timoteo',     f: '2-timoteo',       c: 4  },
      { n: 'Tito',          f: 'tito',            c: 3  },
      { n: 'Filem√≥n',       f: 'filemon',         c: 1  },
      { n: 'Hebreos',       f: 'hebreos',         c: 13 },
      { n: 'Santiago',      f: 'santiago',        c: 5  },
      { n: '1 Pedro',       f: '1-pedro',         c: 5  },
      { n: '2 Pedro',       f: '2-pedro',         c: 3  },
      { n: '1 Juan',        f: '1-juan',          c: 5  },
      { n: '2 Juan',        f: '2-juan',          c: 1  },
      { n: '3 Juan',        f: '3-juan',          c: 1  },
      { n: 'Judas',         f: 'judas',           c: 1  },
      { n: 'Apocalipsis',   f: 'apocalipsis',     c: 22 }
    ];

    // Generar plan de lectura completo
    const plan = [];
    booksDB.forEach(book => {
      for (let i = 1; i <= book.c; i++) {
        plan.push({ n: book.n, f: book.f, c: i });
      }
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // FUNCIONES AUXILIARES
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg, icon = '‚úì') {
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerHTML = `<span class="toast-icon">${icon}</span><span class="toast-message">${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(() => t.classList.add('show'), 10);
      setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
    }

    function updateProgressRing(day) {
      const circ = 326.73;
      document.getElementById('ringProgress').style.strokeDashoffset = circ - (day / 365 * circ);
      document.getElementById('ringDay').textContent = day;
    }

    function updateStats(chapters) {
      const hlCount = Object.keys(highlights).length;
      document.getElementById('statChapters').textContent = `${chapters} ${chapters === 1 ? 'cap√≠tulo' : 'cap√≠tulos'} hoy`;
      document.getElementById('statHighlights').textContent = `${hlCount} ${hlCount === 1 ? 'vers√≠culo resaltado' : 'vers√≠culos resaltados'}`;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // CARGA DE LECTURA (la funci√≥n principal)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function cargarLectura(custom = null) {
      // Cargar JSON solo la primera vez
      if (!bibleData) {
        try {
          const res = await fetch(BIBLIA_URL);
          if (!res.ok) throw new Error(`Error ${res.status}`);
          bibleData = await res.json();
          document.getElementById('gridLibros').innerHTML = booksDB
            .map(b => `<button onclick="seleccionarLibro('${b.f}','${b.n.replace(/'/g,"\\'")}')">${b.n}</button>`)
            .join('');
          showToast('Biblia cargada', 'üìñ');
        } catch (e) {
          console.error('Fall√≥ carga de biblia.json ‚Üí', e);
          showToast('No pude cargar la Biblia üòî', '‚ö†Ô∏è');
          document.getElementById('contenido').innerHTML = '<p style="text-align:center;padding:3rem;color:var(--accent);">Error al cargar biblia.json<br>Verifica que est√© en /public/</p>';
          return;
        }
      }

      // D√≠a del a√±o
      const startYear = new Date(fechaActual.getFullYear(), 0, 0);
      const dayOfYear = Math.floor((fechaActual - startYear) / 86400000) + 1;
      updateProgressRing(dayOfYear);

      // Fecha legible
      const dateStr = fechaActual.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('infoDate').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

      // Lectura del d√≠a o libro completo
      const lectura = custom || plan.slice(
        Math.floor(((dayOfYear - 1) * 1189) / 365),
        Math.floor((dayOfYear * 1189) / 365)
      );

      updateStats(lectura.length);

      let html = '';
      for (const [idx, item] of lectura.entries()) {
        const claveBase = item.f.toLowerCase();
        let cap = bibleData[claveBase]?.[item.c.toString()];

        // Intentos de rescate si no coincide exactamente
        if (!cap) {
          const intentos = [claveBase, claveBase.replace(/-/g,''), claveBase.replace(/-/g,'_')];
          for (const k of intentos) {
            if (bibleData[k]?.[item.c.toString()]) {
              cap = bibleData[k][item.c.toString()];
              break;
            }
          }
        }

        if (!cap) {
          console.warn(`No encontrado: ${item.n} ${item.c} (clave: ${claveBase})`);
          html += `<details class="capitulo-acordeon"><summary class="header-info"><h2>${item.n} ${item.c} (no disponible)</h2></summary></details>`;
          continue;
        }

        html += `
          <details ${idx === 0 ? 'open' : ''} class="capitulo-acordeon">
            <summary class="header-info">
              <h2>${item.n} ${item.c} <span class="chapter-badge">${Object.keys(cap).length} v.</span></h2>
              <span>‚ñº</span>
            </summary>
            <div class="versiculos">
              ${Object.entries(cap).map(([num, texto]) => {
                const vId = `${item.f}_${item.c}_${num}`;
                const hClass = highlights[vId] || '';
                const cleanText = (texto || '')
                  .replace(/[_\n\/]/g, ' ')
                  .replace(/\s+/g, ' ')
                  .trim();

                return `
                  <div class="versiculo" onclick="activarMenu(this, '${item.n} ${item.c}:${num}', '${vId}')">
                    <span class="num">${num}</span>
                    <span class="txt ${hClass}">${cleanText}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </details>`;
      }

      document.getElementById('contenido').innerHTML = html;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // EVENTOS Y FUNCIONES DE INTERFAZ
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.activarMenu = (el, ref, vId) => {
      selectedVersiculo = el;
      selectedInfo = ref;
      currentVId = vId;
      document.querySelectorAll('.versiculo.active').forEach(v => v.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('menuAcciones').classList.add('active');
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    window.desactivarMenu = () => {
      document.getElementById('menuAcciones').classList.remove('active');
      document.querySelectorAll('.versiculo.active').forEach(v => v.classList.remove('active'));
    };

    window.subrayar = (cls) => {
      const txt = selectedVersiculo.querySelector('.txt');
      ['sub-yellow','sub-green','sub-blue'].forEach(c => txt.classList.remove(c));

      if (highlights[currentVId] === cls) {
        delete highlights[currentVId];
        showToast('Resaltado eliminado', 'üóëÔ∏è');
      } else {
        txt.classList.add(cls);
        highlights[currentVId] = cls;
        showToast('Resaltado guardado', '‚ú®');
      }

      localStorage.setItem('biblia365_highlights', JSON.stringify(highlights));
      updateStats(plan.length); // aproximado
      desactivarMenu();
    };

    window.compartirWhatsApp = () => {
      const texto = selectedVersiculo.querySelector('.txt').innerText;
      const url = `https://wa.me/?text=${encodeURIComponent(`"${texto}" ‚Äî ${selectedInfo}`)}`;
      window.open(url, '_blank');
      showToast('Abriendo WhatsApp', 'üí¨');
      desactivarMenu();
    };

    window.generarImagen = () => {
      const helper = document.getElementById('canvas-helper');
      document.getElementById('img-text').innerText = selectedVersiculo.querySelector('.txt').innerText;
      document.getElementById('img-ref').innerText = selectedInfo.toUpperCase();

      html2canvas(helper, { scale: 2, backgroundColor: null }).then(canvas => {
        const link = document.createElement('a');
        link.download = `${selectedInfo.replace(/[: ]/g, '-')}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('Imagen descargada', 'üñºÔ∏è');
      });
      desactivarMenu();
    };

    window.cambiarFuente = (delta) => {
      fontSize = Math.max(16, Math.min(32, fontSize + delta));
      document.querySelectorAll('.versiculos').forEach(el => el.style.fontSize = fontSize + 'px');
      localStorage.setItem('biblia365_fontsize', fontSize);
      showToast(`Tama√±o: ${fontSize}px`, 'üìè');
    };

    window.toggleModo = () => {
      document.body.classList.toggle('dark-mode');
      const dark = document.body.classList.contains('dark-mode');
      localStorage.setItem('biblia365_darkmode', dark);
      showToast(dark ? 'Modo oscuro' : 'Modo claro', 'üåì');
    };

    window.abrirBiblioteca = () => {
      document.getElementById('modalBiblioteca').style.display = 'grid';
    };

    window.seleccionarLibro = (f, n) => {
      const libro = booksDB.find(b => b.f === f);
      if (!libro) return showToast('Libro no encontrado', '‚ö†Ô∏è');

      const capitulos = [];
      for (let i = 1; i <= libro.c; i++) capitulos.push({ n: libro.n, f: libro.f, c: i });

      document.getElementById('modalBiblioteca').style.display = 'none';
      cargarLectura(capitulos);
      showToast(`Leyendo ${n} completo`, 'üìñ');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.cambiarDia = (delta) => {
      fechaActual.setDate(fechaActual.getDate() + delta);
      cargarLectura();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.irAHoy = () => {
      fechaActual = new Date();
      cargarLectura();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast('Volviendo a hoy', 'üìÖ');
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // INICIALIZACI√ìN
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (localStorage.getItem('biblia365_darkmode') === 'true') {
      document.body.classList.add('dark-mode');
    }

    const savedSize = localStorage.getItem('biblia365_fontsize');
    if (savedSize) {
      fontSize = parseInt(savedSize);
      document.querySelectorAll('.versiculos').forEach(el => el.style.fontSize = fontSize + 'px');
    }

    // ¬°Arrancamos!
    cargarLectura();
  </script>
</PageLayout>
