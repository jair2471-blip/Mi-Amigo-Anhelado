---
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Biblia 365 - Mi Amigo Anhelado">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">

  <style is:inline>
    :root {
      --primary: #1a4d2e; --accent: #d4a574; --bg: #faf8f5; --text: #1a202c; --surface: #ffffff; --border: rgba(0,0,0,0.1);
    }
    body.dark-mode {
      --bg: #0a0e0d; --text: #f7fafc; --surface: #1a1f1e; --primary: #52b788; --border: rgba(255,255,255,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background-color: var(--bg); color: var(--text); font-family: 'Crimson Text', serif; transition: 0.3s; }
    
    .main-container { max-width: 800px; margin: 0 auto; padding: 20px; }
    
    .app-header { text-align: center; padding: 20px 0; }
    .progress-container { position: relative; width: 90px; height: 90px; margin: 0 auto; }
    .ring-bg { fill: none; stroke: var(--border); stroke-width: 7; }
    .ring-active { fill: none; stroke: var(--accent); stroke-width: 7; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: 1s; }

    .panel { 
      position: sticky; top: 10px; background: var(--surface); 
      padding: 12px; border-radius: 15px; display: flex; 
      justify-content: space-between; z-index: 100; border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    button { padding: 8px 15px; border: none; border-radius: 8px; background: var(--primary); color: white; cursor: pointer; font-weight: bold; }

    /* Modal Biblioteca */
    #modalBiblioteca { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; place-items: center; z-index: 1000; padding: 20px; }
    .modal-content { background: var(--bg); width: 100%; max-width: 700px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
    .seccion-titulo { margin: 20px 0 10px; border-bottom: 2px solid var(--accent); font-family: 'Playfair Display'; color: var(--primary); }
    .grid-libros { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .btn-lib { background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 10px 5px; font-size: 0.8rem; }

    /* Estilos de Lectura */
    .card { background: var(--surface); border-radius: 15px; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border); }
    .v-num { color: var(--accent); font-weight: bold; margin-right: 8px; font-size: 0.85em; vertical-align: super; }
    .txt-v { font-size: var(--f-size, 20px); line-height: 1.8; margin-bottom: 15px; text-align: justify; }
    .cap-titulo { font-family: 'Playfair Display'; font-size: 2rem; color: var(--primary); margin-bottom: 20px; text-align: center; }

    .nav-footer { display: flex; gap: 10px; margin-top: 30px; padding-bottom: 60px; }
    .btn-nav { flex: 1; padding: 15px; }
  </style>

  <div class="main-container">
    <div class="app-header">
      <h1 style="font-family: 'Playfair Display'; font-size: 2.2rem; color: var(--primary);">BIBLIA 365</h1>
      <div class="progress-container">
        <svg width="90" height="90">
          <circle class="ring-bg" cx="45" cy="45" r="38" />
          <circle id="progreso" class="ring-active" cx="45" cy="45" r="38" stroke-dasharray="238.7" stroke-dashoffset="238.7" />
        </svg>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
          <span id="diaLabel" style="font-weight:bold; font-size:1.2rem;">1</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <button onclick="window.abrirLibros()">üìö Biblioteca</button>
      <div style="display:flex; gap:8px;">
        <button onclick="window.zoom(-2)">A-</button>
        <button onclick="window.zoom(2)">A+</button>
        <button onclick="window.modoNoche()">üåì</button>
      </div>
    </div>

    <div id="lector">
      <p style="text-align:center; padding: 50px;">Abriendo las Escrituras...</p>
    </div>

    <div class="nav-footer">
      <button class="btn-nav" onclick="window.irDia(-1)">Anterior</button>
      <button class="btn-nav" onclick="window.irHoy()">Hoy</button>
      <button class="btn-nav" onclick="window.irDia(1)">Siguiente</button>
    </div>
  </div>

  <div id="modalBiblioteca" onclick="if(event.target==this) window.cerrarLibros()">
    <div class="modal-content">
      <h2 style="text-align:center; font-family: 'Playfair Display';">√çndice de Libros</h2>
      
      <h3 class="seccion-titulo">Antiguo Testamento</h3>
      <div id="listaAT" class="grid-libros"></div>

      <h3 class="seccion-titulo">Nuevo Testamento</h3>
      <div id="listaNT" class="grid-libros"></div>

      <button onclick="window.cerrarLibros()" style="width:100%; margin-top:30px; background:var(--accent)">Regresar</button>
    </div>
  </div>

 <script is:inline>
  // LISTA DE LIBROS
  const booksDB = [
    {n:'G√©nesis', f:'genesis', c:50}, {n:'√âxodo', f:'exodo', c:40}, {n:'Lev√≠tico', f:'levitico', c:27},
    {n:'N√∫meros', f:'numeros', c:36}, {n:'Deuteronomio', f:'deuteronomio', c:34}, {n:'Josu√©', f:'josue', c:24},
    {n:'Jueces', f:'jueces', c:21}, {n:'Rut', f:'rut', c:4}, {n:'1 Samuel', f:'1_samuel', c:31},
    {n:'2 Samuel', f:'2_samuel', c:24}, {n:'1 Reyes', f:'1_reyes', c:22}, {n:'2 Reyes', f:'2_reyes', c:25},
    {n:'1 Cr√≥nicas', f:'1_cronicas', c:29}, {n:'2 Cr√≥nicas', f:'2_cronicas', c:36}, {n:'Esdras', f:'esdras', c:10},
    {n:'Nehem√≠as', f:'nehemias', c:13}, {n:'Ester', f:'ester', c:10}, {n:'Job', f:'job', c:42},
    {n:'Salmos', f:'salmos', c:150}, {n:'Proverbios', f:'proverbios', c:31}, {n:'Eclesiast√©s', f:'eclesiastes', c:12},
    {n:'Cantares', f:'cantares', c:8}, {n:'Isa√≠as', f:'isaias', c:66}, {n:'Jerem√≠as', f:'jeremias', c:52},
    {n:'Lamentaciones', f:'lamentaciones', c:5}, {n:'Ezequiel', f:'ezequiel', c:48}, {n:'Daniel', f:'daniel', c:12},
    {n:'Oseas', f:'oseas', c:14}, {n:'Joel', f:'joel', c:3}, {n:'Am√≥s', f:'amos', c:9},
    {n:'Abd√≠as', f:'abdias', c:1}, {n:'Jon√°s', f:'jonas', c:4}, {n:'Miqueas', f:'miqueas', c:7},
    {n:'Nah√∫m', f:'nahum', c:3}, {n:'Habacuc', f:'habacuc', c:3}, {n:'Sofon√≠as', f:'sofonias', c:3},
    {n:'Hageo', f:'hageo', c:2}, {n:'Zacar√≠as', f:'zacarias', c:14}, {n:'Malaqu√≠as', f:'malaquias', c:4},
    {n:'Mateo', f:'mateo', c:28}, {n:'Marcos', f:'marcos', c:16}, {n:'Lucas', f:'lucas', c:24},
    {n:'Juan', f:'juan', c:21}, {n:'Hechos', f:'hechos', c:28}, {n:'Romanos', f:'romanos', c:16},
    {n:'1 Corintios', f:'1_corintios', c:16}, {n:'2 Corintios', f:'2_corintios', c:13}, {n:'G√°latas', f:'galatas', c:6},
    {n:'Efesios', f:'efesios', c:6}, {n:'Filipenses', f:'filipenses', c:4}, {n:'Colosenses', f:'colosenses', c:4},
    {n:'1 Tesalonicenses', f:'1_tesalonicenses', c:5}, {n:'2 Tesalonicenses', f:'2_tesalonicenses', c:3},
    {n:'1 Timoteo', f:'1_timoteo', c:6}, {n:'2 Timoteo', f:'2_timoteo', c:4}, {n:'Tito', f:'tito', c:3},
    {n:'Filem√≥n', f:'filemon', c:1}, {n:'Hebreos', f:'hebreos', c:13}, {n:'Santiago', f:'santiago', c:5},
    {n:'1 Pedro', f:'1_pedro', c:5}, {n:'2 Pedro', f:'2_pedro', c:3}, {n:'1 Juan', f:'1_juan', c:5},
    {n:'2 Juan', f:'2_juan', c:1}, {n:'3 Juan', f:'3_juan', c:1}, {n:'Judas', f:'judas', c:1},
    {n:'Apocalipsis', f:'apocalipsis', c:22}
  ];

  let bibliaJSON = null;
  let fechaActual = new Date();
  let plan = [];
  booksDB.forEach(b => { for(let i=1; i<=b.c; i++) plan.push({n:b.n, f:b.f, c:i}); });

  // CARGA CON DIAGN√ìSTICO
  async function cargarBiblia() {
    const contenedor = document.getElementById('lector');
    try {
      const res = await fetch('/biblia.json'); 
      if (!res.ok) throw new Error(`Archivo no encontrado (Status: ${res.status})`);
      
      bibliaJSON = await res.json();
      console.log("Biblia cargada correctamente");
      cargarLectura(); // Inicia la lectura del d√≠a
    } catch (e) {
      console.error(e);
      contenedor.innerHTML = `
        <div class="card" style="border:2px solid #e76f51; padding:2rem; text-align:center;">
          <h2 style="color:#e76f51">‚ö†Ô∏è Error al cargar el archivo</h2>
          <p>No pudimos leer <b>biblia.json</b>.</p>
          <div style="text-align:left; background:rgba(0,0,0,0.1); padding:1rem; border-radius:10px; margin-top:1rem; font-family:monospace; font-size:0.8rem;">
            Error: ${e.message}
          </div>
          <p style="margin-top:1rem; font-size:0.9rem;">Aseg√∫rate de que el archivo est√© en la carpeta <b>public/</b> de tu proyecto Astro.</p>
        </div>
      `;
    }
  }

  // BUSCADOR INTELIGENTE (Para que aparezca "Juan")
  function buscarLibro(nombre) {
    if (!bibliaJSON) return null;
    // 1. Intento exacto
    if (bibliaJSON[nombre]) return bibliaJSON[nombre];
    // 2. Intento flexible (min√∫sculas, incluye nombre, etc)
    const keys = Object.keys(bibliaJSON);
    const encontrada = keys.find(k => k.toLowerCase().includes(nombre.toLowerCase()) || nombre.toLowerCase().includes(k.toLowerCase()));
    return encontrada ? bibliaJSON[encontrada] : null;
  }

  function cargarLectura(especifico = null) {
    const lector = document.getElementById('lector');
    const hoy = Math.floor((fechaActual - new Date(fechaActual.getFullYear(), 0, 0)) / 86400000);
    const items = especifico || plan.slice((hoy - 1) * 3, (hoy - 1) * 3 + 3);
    
    let html = '';
    items.forEach(it => {
      const libroData = buscarLibro(it.n);
      const capData = libroData ? libroData[it.c] : null;

      if (capData) {
        html += `<div class="capitulo-acordeon" style="margin-bottom:2rem">
          <div class="header-info" style="padding:1rem; background:var(--primary); color:white; border-radius:15px 15px 0 0">
            <h2 style="margin:0">${it.n} ${it.c}</h2>
          </div>
          <div class="versiculos" style="background:var(--surface); padding:1.5rem; border-radius:0 0 15px 15px; border:1px solid var(--border)">`;
        
        Object.entries(capData).forEach(([num, texto]) => {
          // Limpieza de texto (/n y n√∫meros dobles)
          let textoLimpio = texto
            .replace(new RegExp('^' + num + '/n'), '')
            .replace(/^\d+\/n/, '')
            .replace(/\/n/g, '<br>');

          html += `<p class="versiculo" style="margin-bottom:1rem">
            <span class="num" style="color:var(--accent); font-weight:bold; margin-right:0.5rem">${num}</span>
            <span class="txt">${textoLimpio}</span>
          </p>`;
        });
        html += `</div></div>`;
      } else {
        html += `<div class="card"><p>No se encontr√≥ el contenido para ${it.n} ${it.c}. Revisa si el nombre en el JSON es exacto.</p></div>`;
      }
    });

    lector.innerHTML = html;
    // Actualizar UI de progreso si tienes las funciones
    if (typeof updateProgressRing === 'function') updateProgressRing(hoy);
    if (typeof updateStats === 'function') updateStats(hoy);
  }

  // Evento inicial
  document.addEventListener('DOMContentLoaded', cargarBiblia);
</script>
</PageLayout>
