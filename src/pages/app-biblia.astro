---
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Biblia 365 - Mi Amigo Anhelado">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">

  <style is:inline>
    :root {
      --primary: #1a4d2e; --accent: #d4a574; --bg: #faf8f5; --text: #1a202c; --surface: #ffffff;
    }
    body.dark-mode {
      --bg: #0a0e0d; --text: #f7fafc; --surface: #1a1f1e; --primary: #52b788;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background-color: var(--bg); color: var(--text); 
      font-family: 'Crimson Text', serif; transition: 0.3s;
    }
    .main-container { max-width: 800px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .app-header { text-align: center; padding: 20px 0; }
    .progress-container { position: relative; width: 100px; height: 100px; margin: 0 auto; }
    .ring-bg { fill: none; stroke: #ddd; stroke-width: 8; }
    .ring-active { fill: none; stroke: var(--accent); stroke-width: 8; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: 1s; }

    /* Botones y Panel */
    .panel { 
      position: sticky; top: 10px; background: var(--surface); 
      padding: 15px; border-radius: 15px; display: flex; 
      justify-content: space-between; z-index: 100; border: 1px solid #ddd;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    button { 
      padding: 10px 15px; border: none; border-radius: 8px; 
      background: var(--primary); color: white; cursor: pointer; font-weight: bold;
    }
    button:active { transform: scale(0.95); }

    /* Modal Biblioteca */
    #modalBiblioteca { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
      display: none; place-items: center; z-index: 1000; 
    }
    .modal-content { 
      background: var(--bg); width: 90%; max-width: 500px; 
      padding: 20px; border-radius: 20px; max-height: 80vh; overflow-y: auto; 
    }
    .grid-libros { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
      gap: 10px; margin-top: 20px; 
    }
    .btn-lib { background: var(--surface); color: var(--text); border: 1px solid #ddd; font-size: 0.8rem; }

    /* Lectura */
    .card { background: var(--surface); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid #ddd; }
    .v-num { color: var(--accent); font-weight: bold; margin-right: 8px; font-size: 0.9em; }
    .txt-v { font-size: var(--f-size, 20px); line-height: 1.6; }

    .nav-footer { display: flex; gap: 10px; margin-top: 30px; }
    .btn-nav { flex: 1; padding: 15px; }
  </style>

  <div class="main-container">
    <div class="app-header">
      <h1 style="font-family: 'Playfair Display';">BIBLIA 365</h1>
      <div class="progress-container">
        <svg width="100" height="100">
          <circle class="ring-bg" cx="50" cy="50" r="40" />
          <circle id="progreso" class="ring-active" cx="50" cy="50" r="40" stroke-dasharray="251.2" stroke-dashoffset="251.2" />
        </svg>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
          <span id="diaLabel" style="font-weight:bold; font-size:1.2rem;">1</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <button onclick="window.abrirLibros()">ðŸ“š Libros</button>
      <div style="display:flex; gap:8px;">
        <button onclick="window.zoom(-2)">A-</button>
        <button onclick="window.zoom(2)">A+</button>
        <button onclick="window.modoNoche()">ðŸŒ“</button>
      </div>
    </div>

    <div id="lector"></div>

    <div class="nav-footer">
      <button class="btn-nav" onclick="window.irDia(-1)">â—€ Ant.</button>
      <button class="btn-nav" onclick="window.irHoy()">Hoy</button>
      <button class="btn-nav" onclick="window.irDia(1)">Sig. â–¶</button>
    </div>
  </div>

  <div id="modalBiblioteca" onclick="if(event.target==this) window.cerrarLibros()">
    <div class="modal-content">
      <h3 style="text-align:center">Selecciona un Libro</h3>
      <div id="listaLibros" class="grid-libros"></div>
      <button onclick="window.cerrarLibros()" style="width:100%; margin-top:20px; background:var(--accent)">Cerrar</button>
    </div>
  </div>

  <script is:inline>
    // 1. Datos de la Biblia
    const BOOKS = [
      {n:'GÃ©nesis', f:'genesis', c:50}, {n:'Ã‰xodo', f:'exodo', c:40}, {n:'LevÃ­tico', f:'levitico', c:27},
      {n:'NÃºmeros', f:'numeros', c:36}, {n:'Deuteronomio', f:'deuteronomio', c:34}, {n:'JosuÃ©', f:'josue', c:24},
      {n:'Jueces', f:'jueces', c:21}, {n:'Rut', f:'rut', c:4}, {n:'1 Samuel', f:'1_samuel', c:31},
      {n:'2 Samuel', f:'2_samuel', c:24}, {n:'1 Reyes', f:'1_reyes', c:22}, {n:'2 Reyes', f:'2_reyes', c:25},
      {n:'Mateo', f:'mateo', c:28}, {n:'Marcos', f:'marcos', c:16}, {n:'Lucas', f:'lucas', c:24},
      {n:'Juan', f:'juan', c:21}, {n:'Hechos', f:'hechos', c:28}, {n:'Apocalipsis', f:'apocalipsis', c:22}
    ];

    let plan = [];
    BOOKS.forEach(b => { for(let i=1; i<=b.c; i++) plan.push({n:b.n, f:b.f, c:i}); });

    let fecha = new Date();
    let fontSize = 20;

    // 2. FUNCIONES GLOBALES (Atadas a window para que los botones funcionen)
    window.abrirLibros = () => {
      const lista = document.getElementById('listaLibros');
      lista.innerHTML = BOOKS.map(b => `
        <button class="btn-lib" onclick="window.cargarLibro('${b.f}', '${b.n}')">${b.n}</button>
      `).join('');
      document.getElementById('modalBiblioteca').style.display = 'grid';
    };

    window.cerrarLibros = () => document.getElementById('modalBiblioteca').style.display = 'none';

    window.cargarLibro = (f, n) => {
      window.cerrarLibros();
      renderLectura([{f, n, c: 1}]);
    };

    window.zoom = (n) => {
      fontSize += n;
      document.documentElement.style.setProperty('--f-size', fontSize + 'px');
    };

    window.modoNoche = () => document.body.classList.toggle('dark-mode');

    window.irDia = (d) => {
      fecha.setDate(fecha.getDate() + d);
      window.iniciarApp();
    };

    window.irHoy = () => {
      fecha = new Date();
      window.iniciarApp();
    };

    async function renderLectura(items) {
      const lector = document.getElementById('lector');
      lector.innerHTML = '<p style="text-align:center">Cargando Palabra...</p>';
      
      let html = '';
      for (const it of items) {
        try {
          const res = await fetch(`https://bible-api.deno.dev/api/read/rvv1960/${it.f}/${it.c}`);
          const data = await res.json();
          html += `
            <div class="card">
              <h2 style="color:var(--primary); margin-bottom:15px; border-bottom:2px solid var(--accent); display:inline-block">${it.n} ${it.c}</h2>
              <div>
                ${data.vers.map(v => `<p style="margin-bottom:10px" class="txt-v"><span class="v-num">${v.number}</span>${v.verse}</p>`).join('')}
              </div>
            </div>
          `;
        } catch (e) { console.error(e); }
      }
      lector.innerHTML = html || '<p>Error de conexiÃ³n</p>';
      window.scrollTo(0,0);
    }

    window.iniciarApp = () => {
      const inicio = new Date(fecha.getFullYear(), 0, 0);
      const diaAnio = Math.floor((fecha - inicio) / 86400000);
      const idx = (diaAnio - 1) * 3;
      const hoyItems = plan.slice(idx, idx + 3);

      document.getElementById('diaLabel').innerText = diaAnio;
      const offset = 251.2 - (diaAnio / 365) * 251.2;
      document.getElementById('progreso').style.strokeDashoffset = offset;

      renderLectura(hoyItems);
    };

    // Arrancar
    document.addEventListener('DOMContentLoaded', window.iniciarApp);
  </script>
</PageLayout>